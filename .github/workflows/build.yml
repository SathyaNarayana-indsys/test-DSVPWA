name: Build Pipeline
run-name: Commit - ${{ github.sha }} on ${{ github.ref_name }}

on: 
    push:
        branches:
          - 'main'

env:
  BREAK_ON_FAILURE_FLAG: false # Set to true or false

jobs:
    sast:
        name: Running SAST [BearerCLI] on project
        runs-on: ubuntu-latest 
        outputs:
          output_json: ${{ steps.sast.outputs.outputJson}}
        steps: 
          - name: Checkout code
            uses: actions/checkout@v4
          - name: Run Bearer SAST
            # id: bearer
            uses: bearer/bearer-action@v2
            with:
              scanner: sast
              quiet: true
              format: json
              output: SAST-results.json
          - name: output
            id: sast
            run: "outputJson=$(cat SAST-results.json)" >> $GITHUB_OUTPUT

    sbom_generator:
        name: Running Syft [SBOM generator] on project
        runs-on: ubuntu-latest
        outputs:
          output_json: ${{ steps.sbom.outputs.outputJson}}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - uses: anchore/sbom-action@v0
              id: syft
              with:
                format: spdx-json
                output-file: sbom.json
            - name: output
              id: sbom
              run: "outputJson=$(cat sbom.json)" >> $GITHUB_OUTPUT

    secret_detection:
        name: Running Truffle-Hog on project
        runs-on: ubuntu-latest
        outputs:
            output_json: ${{ steps.secrets.outputJson }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Secret Scanning
              id: truffleHog
              uses: trufflesecurity/trufflehog@main
              with:
                path: ./ 
                extra_args: --json --log-level=-1 >> secrets.json
            - name: output
              id: secrets
              run: "outputJson=$(cat secrets.json)" >> $GITHUB_OUTPUT

    sca:
        name: Running Grype [SCA] on project
        runs-on: ubuntu-latest
        outputs:
            output_json: ${{ steps.sca.outputJson }}
        steps:
        - name: Checkout code
          uses: actions/checkout@v4
        - name: Run Anchore Scan
          uses: anchore/scan-action@v6
          id: grype
          with:
                path: "."
                only-fixed: true
                severity-cutoff: high
                output-file: SCA.json
                output_format: json
        - name: output
          id: sca
          run: "outputJson=$(cat SCA.json)" >> $GITHUB_OUTPUT

    PublishOutput:
      name: Publishing output of all Steps after basic Review
      runs-on: ubuntu-latest
      needs: [sast, sbom_generator, secret_detection, sca]
      if: always()
      steps:
            # - run: echo "Pushing Files into Reports Repo"
            -  name: checkout the reports repo
               uses: actions/checkout@v4
               with:
                repository: ${{ vars.repo_link }}
                path: reports-repo
                token: ${{ secrets.REPORTS_REPO_PAT }}
            -  name: Check if Current Repo exist else Create
               id: checkFolder
               env: 
                REPO_NAME: ${{ github.event.repository.name }}
               run: |
                  echo "Checking Repo's existance"
                  if [ -d "reports-repo/$REPO_NAME" ]; then
                    echo "folder exists"
                  else
                    echo "creating the folders"
                    mkdir -p reports-repo/$REPO_NAME
                  fi
            -  name: copy, commit and push changes
               id: copy_reports
               env:
                SAST_REPORT: ${{ needs.sast.outputs.output_json }}
                SBOM_REPORT: ${{ needs.sbom_generator.outputs.output_json }}
                SECRET_REPORT: ${{ needs.secret_detection.outputs.output_json }}
                SCA_REPORT: ${{ needs.sca.outputs.output_json }}
                FOLDER: reports-repo/${{ github.event.repository.name }}
               run: |
                  echo "pushing files into reports Repo"

                  echo $SAST_REPORT > $FOLDER/sast-results.json
                  echo $SBOM_REPORT > $FOLDER/sbom-results.json
                  echo $SECRET_REPORT > $FOLDER/secrets-results.json
                  echo $SCA_REPORT > $FOLDER/sca-results.json
                  
                  cd reports-repo
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  if git diff --exit-code --quiet; then
                    echo "No changes to commit."
                  else
                    git add .
                    
                    # Determine which files were changed/added (A or M status)
                    CHANGED_FILES=$(git status --porcelain | grep '^[AM]' | awk '{print $2}' | xargs basename | tr '\n' ', ')
                    # Remove trailing comma and space
                    CHANGED_FILES="${CHANGED_FILES%, }"
                    
                    # Extract short branch name
                    BRANCH_NAME=$(echo ${{ github.ref_name }} | sed 's/refs\/heads\///')
                    
                    # Create the custom commit message
                    COMMIT_MESSAGE="Report Update: ${{ github.event.repository.name }}/${BRANCH_NAME} - Files: $CHANGED_FILES"
                    
                    git commit -m "$COMMIT_MESSAGE"
                    git push
                    echo "Successfully pushed report changes to the reports repository."
                    echo "Commit Message: $COMMIT_MESSAGE"
                  fi

    build:
      name: Running Build
      runs-on: ubuntu-latest
      needs: [PublishOutput, sast, sbom_generator, secret_detection, sca]
      steps:
        - name: Conditional Build Step
          run: |
            if [[ "$BREAK_ON_FAILURE_FLAG" == "true" ]]; then
              echo "BREAK_ON_FAILURE_FLAG is false, continuing only if all reports were successful."
              if [[ "${{ needs.sast.result }}" != "success" ]] || \
                [[ "${{ needs.sbom_generator.result }}" != "success" ]] || \
                [[ "${{ needs.secret_detection.result }}" != "success" ]] || \
                [[ "${{ needs.sca.result }}" != "success" ]]; then
                echo "One or more checks failed. Skipping build."
                exit 0
              fi
            else
              echo "BREAK_ON_FAILURE_FLAG is false, running regardless of reports."
            fi
        - run: echo "PR approved, Running Build"

    #         - name: Checkout code
    #           uses: actions/checkout@v4
    #         - name: Set up SSH Key
    #           uses: webfactory/ssh-agent@v0.9.0
    #           with:
    #             ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY}}
    #         - name: Deploy
    #           run:  rsync -avz --exclude '.git' --chown=github:www-data --chmod=Dg=rwx,Fg=rwx ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ vars.deploymentFolder }}
    #         - name: Execute script on EC2
    #           run: |
    #               ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF' 
    #                 chmod +x ${{ vars.deploymentFolder }}/${{ vars.deploymentFile }}
    #                 /bin/bash ${{ vars.deploymentFolder }}/${{ vars.deploymentFile }}
    #               EOF



